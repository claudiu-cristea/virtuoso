<?xml version="1.0" encoding="UTF-8" ?>

<project name="Virtuoso" default="help" basedir=".">
    <property name="virtuoso.root" value="${project.basedir}/vendor/ec-europa/virtuoso"/>

    <taskdef name="virtuoso-set-update-permission" classname="Virtuoso\Task\SetVirtuosoSparqlPermissions"/>

    <taskdef name="rdf-import-fixtures" classname="Virtuoso\Task\ImportRdfFixtures"/>

    <taskdef name="rdf-purge" classname="Virtuoso\Task\RdfPurge"/>

    <taskdef name="virtuoso-stop" classname="Virtuoso\Task\StopVirtuoso"/>

    <target name="virtuoso-start">
        <if>
            <available file="${virtuoso.root}/db/virtuoso.lck"/>
            <then>
                <fail message="Virtuoso is already running."/>
            </then>
            <else>
                <exec
                        command="${virtuoso.binary} +configfile ${virtuoso.root}/db/virtuoso.ini +wait"
                        dir="${virtuoso.root}/db"
                        passthru="true"
                        checkreturn="true"
                        logoutput="true"
                />
            </else>
        </if>

    </target>

    <target name="virtuoso-stop">
        <if>
            <available file="${virtuoso.root}/db/virtuoso.lck"/>
            <then>
                <virtuoso-stop
                        IsqlPath="${isql.bin}"
                        DataSourceName="${sparql.dsn}"
                        Username="${sparql.user}"
                        Password="${sparql.password}"/>
            </then>
            <else>
                <echo msg="Virtuoso not running, shutdown not required."/>
            </else>
        </if>

    </target>
    <target name="virtuoso-restore-backup" depends="virtuoso-stop, virtuoso-setup">
        <exec
                command="${virtuoso.binary} +configfile ${virtuoso.root}/db/virtuoso.ini +restore-backup 20171011_JOINUP_FULL_DUMP_"
                dir="${virtuoso.root}/backup"
                passthru="true"
                checkreturn="true"
                logoutput="true"
        />
        <phingcall target="virtuoso-start"/>

    </target>

    <target name="virtuoso-restart" depends="virtuoso-stop, virtuoso-start"/>
    <target name="virtuoso-setup">
        <!-- Create virtuoso.ini -->
        <if>
            <available file="${virtuoso.root}/db/virtuoso.lck"/>
            <then>
                <fail message="Virtuoso is still running."/>
            </then>
            <else>
                <delete dir="${virtuoso.root}/db" includeemptydirs="true" verbose="true" failonerror="true"/>
                <mkdir dir="${virtuoso.root}/db"/>
                <copy file="${virtuoso.root}/virtuoso.ini.template" tofile="${virtuoso.root}/db/virtuoso.ini">
                    <filterchain>
                        <expandproperties/>
                    </filterchain>
                </copy>
            </else>
        </if>
    </target>
</project>
